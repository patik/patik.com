<?phprequire_once($_SERVER['DOCUMENT_ROOT'] . '/inc/keys.php');function get_image_url($page_url){  $image_url = '';	preg_match('@^(?:http://)?([^/]+)@i',$page_url, $matches);	$host = $matches[1];	preg_match('/[^.]+\.[^.]+$/', $host, $matches);	$domain = "{$matches[0]}";	# Check for previously-stored URLs	$linkURL = mysql_connect(MYSQL_HOST, MYSQL_USER_SNR, MYSQL_PASSWORD);	if (!$linkURL) { die('Could not connect: ' . mysql_error()); }	mysql_select_db('snr_tpurls',$linkURL);	$query = "SELECT * FROM ch_image_urls WHERE page_url='" . mysql_real_escape_string($page_url) . "'";	$result = mysql_query($query,$linkURL);	if ($result) {		if (mysql_num_rows($result) === 1) {			$row = mysql_fetch_assoc($result);			$image_url = $row['image_url'];			if (empty($long_url)) {				$hits = $row['hits'] + 1;				$query = "UPDATE ch_image_urls SET hits=$hits WHERE image_url='$image_url'";				$result = mysql_query($query,$linkURL);			}		}	}	# Else, extract from page HTML	if (empty($image_url)) {		$ch = curl_init();		curl_setopt($ch, CURLOPT_URL, $page_url);		curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);		curl_setopt($ch, CURLOPT_USERAGENT, "RSS/Feed/Fan/1.0");		$html = curl_exec($ch);		curl_close($ch);    $pattern = '@<p\sclass\=\"feature_item\">(.+)</p>@i';    preg_match($pattern, $html, $matches);    if (empty($matches)) {      return 'Error: no matches for first pattern';    }    $html = $matches[0];    $pattern = '@<img.+class\=\"strip\".+src\=\"(.+)\".+/></p>@i';    preg_match($pattern, $html, $matches);    if (empty($matches)) {      return 'Error: no matches for second pattern';    }    $image_url = $matches[0];    if (empty($image_url)) {      return 'Error: image_url empty when pulling from matches[0]';    }		# Add to DB		$query  = "INSERT INTO ch_image_urls (page_url, image_url, hits) VALUES (";		$query .= "'" . mysql_real_escape_string($page_url) . "'";		$query .= ",'" . mysql_real_escape_string($image_url) . "'";		$query .= ",1)";		$result = mysql_query($query,$linkURL);	}	@mysql_close($linkURL);	return $image_url;	/*	CREATE TABLE `snr_tpurls`.`ch_image_urls` (	`page_url` VARCHAR( 512 ) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL ,	`image_url` VARCHAR( 512 ) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL ,	`hits` INTEGER( 5 ) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL ,	PRIMARY KEY ( `page_url` )	) ENGINE = MYISAM CHARACTER SET utf8 COLLATE utf8_general_ci;	*/}# Input$page_url = $_GET['url'];$callback = $_GET['cb'];# Defaults$image_url = "";if (!empty($page_url)) {  $image_url = get_image_url($page_url);}# Ajax requestif (!empty($_SERVER['HTTP_X_REQUESTED_WITH']) && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) == 'xmlhttprequest') {  # Defaults  header("Content-Type: text/javascript");  $ajax_response = '{"okay":false, "image_url":"", "page_url":"", "message":"Something went wrong."}';  if (empty($image_url) || stripos($image_url, 'Error:') !== false) {    if (!empty($callback)){      echo $callback . '({"okay":false, "image_url":"", "page_url":"", "message":"Result: '. $image_url . '"});';    }    else {      echo '{"okay":false, "image_url":"", "page_url":"", "message":"' . $image_url . '"}';    }  }  else if (!empty($callback) && empty($page_url)) {    echo 'try { console.log("Page URL was empty. Callback was " + ' . $callback . '); } catch(e) { }';  }  else if (!empty($page_url) && empty($callback)) {    echo 'try { console.log("Callback was empty. Page URL was "' . $page_url .'); } catch(e) { }';  }  echo $ajax_response;}# Direct (HTTP) requestelse {  header("Content-Type: text/html");?><!doctype html><html lang="en"><head>  <meta charset="utf-8">  <meta name="viewport" content="width=device-width,initial-scale=1">	<!--[if lt IE 9]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->  <title>Comics.com Image Grabber user script - Patik.com</title>  <script src="http://use.typekit.net/tfz6xpv.js"></script>  <script>try { Typekit.load(); } catch (e) { }</script>  <style>    html { font-size: 100%; -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility; }    body { font-size: 16px; line-height: 1.25; max-width: 960px; margin: 1em auto; }    body, input { color: #444; font-family: ff-tisa-web-pro-1, ff-tisa-web-pro-2, Palatino Linotype, Palatino, serif; }    h1, h2 { font-weight: bold; font-weight: 700; font-family: ff-masala-web-pro-1, ff-masala-web-pro-2, Calibri, Trebuchet, Helvetica, sans-serif; }    header, section { display: block; margin-bottom: 1em; }    img { max-width: 100%; height: auto; }    .bm, .bm:visited, .bm:link { display: inline-block; padding: 0.25em; border: 1px solid #0069d2; color: #0069d2; background-color: rgba(0,105,210,0.3); }    .bm:hover, .bm:focus, .bm:active { display: inline-block; padding: 0.25em; border: 1px solid #0069d2; color: white; background-color: rgba(0,105,210,0.8); }  </style></head><body>  <header>    <h1>Comics.com Image Grabber user script for Google Reader</h1>  </header>  <section id="instructions">    <h2>Instructions</h2>    <p>Firefox with Greasemonkey or Google Chrome: <a class="bm" href="comicscom-image-grabber.user.js">Install</a></p>  </section>  <?php if (!empty($image_url)) { ?>    <section id="result">      <h2>Results</h2>      <p>Given URL: <tt><a href="<?php echo $page_url; ?>"><?php echo $page_url; ?></a></tt></p>      <p>Result: <input type="url" size="<?php echo strval(strlen($image_url)+2); ?>" value="<?php echo $page_url; ?>"></p>      <p><img class="comic" src="<?php echo strval(strlen($image_url)+2); ?>" value="<?php echo $page_url; ?>"></p>    </section>  <?php } ?></body></html><?php}?>